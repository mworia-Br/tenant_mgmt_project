name: CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  KUBE_NAMESPACE: tenant-mgmt

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ðŸ” Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ” Convert repository owner to lowercase
      run: echo "IMAGE_NAMESPACE_LC=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

    - name: ðŸ³ Build & Push Django API Image
      run: |
        docker build backend/django_api -t $REGISTRY/$IMAGE_NAMESPACE_LC/tenant-django-api:latest
        docker push $REGISTRY/$IMAGE_NAMESPACE_LC/tenant-django-api:latest

    - name: ðŸ³ Build & Push FastAPI Worker Image
      run: |
        docker build backend/fastapi_worker -t $REGISTRY/$IMAGE_NAMESPACE_LC/tenant-fastapi-worker:latest
        docker push $REGISTRY/$IMAGE_NAMESPACE_LC/tenant-fastapi-worker:latest

    - name: ðŸ“‚ Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: ðŸ”‘ Configure Kubeconfig
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config

    - name: ðŸš€ Deploy to Kubernetes
      run: |
        kubectl apply -n $KUBE_NAMESPACE -f infra/kubernetes/postgres-deployment.yml
        kubectl apply -n $KUBE_NAMESPACE -f infra/kubernetes/redis-deployment.yml
        kubectl apply -n $KUBE_NAMESPACE -f infra/kubernetes/django-api-deployment.yml
        kubectl apply -n $KUBE_NAMESPACE -f infra/kubernetes/fastapi-worker-deployment.yml
        kubectl apply -n $KUBE_NAMESPACE -f infra/kubernetes/ingress.yml
